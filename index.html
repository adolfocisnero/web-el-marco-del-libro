<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Marco del Libro VIP</title>
    
    <link rel="apple-touch-icon" href="https://i.ibb.co/NgksQ0Sh/photo-2025-07-20-02-21-51.jpg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="https://i.ibb.co/NgksQ0Sh/photo-2025-07-20-02-21-51.jpg">

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { 
            --gold: #ffcc00; 
            --blue: #0033a0; 
            --red: #ce1126; 
            --card: rgba(10, 20, 32, 0.85); 
            --neon-tri: linear-gradient(45deg, #ffcc00, #0033a0, #ce1126, #ffcc00); 
        }

        /* FONDO DE UNIVERSO EN MOVIMIENTO */
        body { 
            background: #050C17; 
            color: white; 
            font-family: 'Montserrat', sans-serif; 
            margin: 0; 
            padding-bottom: 90px; 
            min-height: 100vh; 
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(0, 51, 160, 0.2), transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(206, 17, 38, 0.1), transparent 40%),
                radial-gradient(1px 1px at 10% 10%, white, transparent),
                radial-gradient(1px 1px at 20% 50%, white, transparent),
                radial-gradient(2px 2px at 40% 80%, white, transparent),
                radial-gradient(1px 1px at 60% 20%, white, transparent),
                radial-gradient(2px 2px at 80% 40%, white, transparent);
            background-size: 100% 100%, 100% 100%, 200px 200px, 350px 350px, 400px 400px, 250px 250px, 300px 300px;
            z-index: -1;
            animation: spaceMove 20s linear infinite alternate;
        }

        @keyframes spaceMove {
            from { background-position: 0% 0%; }
            to { background-position: 5% 5%; }
        }

        .header-container { text-align: center; padding: 30px 0; position: relative; z-index: 10; }
        
        .halo-circle { 
            width: 140px; height: 140px; margin: 0 auto 20px auto; padding: 3px; 
            background: var(--neon-tri); border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            background-size: 300% 300%; animation: neonFlow 4s linear infinite;
            box-shadow: 0 0 30px rgba(255, 204, 0, 0.4);
        }
        .logo-img { width: 135px; height: 135px; border-radius: 50%; object-fit: cover; background: #050C17; }
        
        .brand-box { 
            display: inline-block; 
            padding: 10px 30px; 
            background: rgba(0,0,0,0.7); 
            position: relative;
            border-radius: 4px;
            backdrop-filter: blur(5px);
        }
        .brand-box::before {
            content: ""; position: absolute; inset: 0; border-radius: 4px; padding: 2px; 
            background: var(--neon-tri); background-size: 300% 300%;
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor; mask-composite: exclude;
            animation: neonFlow 4s linear infinite;
        }

        .brand-name { 
            font-family: 'Cinzel'; color: white; font-size: 22px; letter-spacing: 4px; margin: 0; 
            text-shadow: 0 0 10px var(--gold);
        }

        @keyframes neonFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .grid { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 15px; 
            padding: 15px; 
            max-width: 1200px; 
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }
        @media (min-width: 768px) { .grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1024px) { .grid { grid-template-columns: repeat(3, 1fr); } }

        .libro-card { 
            background: var(--neon-tri); background-size: 300% 300%; animation: neonFlow 5s linear infinite;
            padding: 1.5px; border-radius: 12px; display: flex; transition: transform 0.3s;
        }
        .libro-card:hover { transform: translateY(-5px); }

        .card-body {
            background: var(--card); border-radius: 11px; padding: 12px;
            display: flex; align-items: center; gap: 15px; width: 100%;
            backdrop-filter: blur(10px);
        }

        .img-box { 
            width: 100px; height: 130px; 
            background: white; border-radius: 6px; 
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden; flex-shrink: 0; padding: 8px; box-sizing: border-box;
        }
        .img-box img { max-height: 100%; max-width: 100%; object-fit: contain; }
        
        .info-box { flex-grow: 1; text-align: left; }
        .status { font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 5px; }
        .status-ok { background: rgba(0, 255, 100, 0.15); color: #00ff64; border: 1px solid #00ff64; }
        .status-no { background: rgba(255, 0, 0, 0.15); color: #ff3333; border: 1px solid #ff3333; }

        #admin-content { display: flex; flex-direction: column; gap: 12px; max-width: 600px; margin: 0 auto; }
        .admin-card { display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--card); border-radius: 10px; border: 1px solid #333; }

        .panel { position: fixed; inset: 0; background: #050C17; z-index: 5000; display: none; overflow-y: auto; padding: 20px; }
        .active { display: block; }
        .card-ui { background: var(--card); padding: 18px; border-radius: 12px; border: 1px solid #1a2a3a; max-width: 450px; margin: 12px auto; backdrop-filter: blur(10px); }
        
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #333; background: #000; color: white; box-sizing: border-box; }
        .btn-gold { background: var(--gold); color: black; border: none; padding: 14px; font-weight: bold; border-radius: 8px; cursor: pointer; width: 100%; text-transform: uppercase; transition: 0.3s; }
        
        .nav-bot { position: fixed; bottom: 0; width: 100%; background: rgba(5, 12, 23, 0.95); display: flex; justify-content: space-around; padding: 18px 0; border-top: 1px solid #1a2a3a; z-index: 4000; backdrop-filter: blur(10px); }
        .nav-bot i { font-size: 24px; cursor: pointer; color: white; }

        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; display: none; width: 280px; }
        .msg-card { padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .msg-success { background: #1b4d31; color: #5effa3; }
        .msg-error { background: #4d1b1b; color: #ff5e5e; }
    </style>
</head>
<body>

<div id="toast"></div>

<div id="main-view">
    <div class="header-container">
        <div class="halo-circle"><img src="https://i.ibb.co/NgksQ0Sh/photo-2025-07-20-02-21-51.jpg" class="logo-img"></div>
        <div class="brand-box"><h1 class="brand-name">EL MARCO DEL LIBRO</h1></div>
        <div style="margin-top: 25px; padding: 0 20px; max-width: 500px; margin-inline: auto;">
            <input type="text" id="busq-tienda" placeholder="游댌 Buscar libro o autor..." onkeyup="filtrar('tienda')" autocomplete="off">
        </div>
    </div>
    <div id="box-libros" class="grid"></div>
</div>

<div class="nav-bot">
    <i class="fas fa-home" onclick="cerrarPaneles()" style="color:var(--gold);"></i>
    <div onclick="abrirPanel('p-cart')" style="position:relative;">
        <i class="fas fa-shopping-cart"></i>
        <span id="badge" style="position:absolute; top:-8px; right:-12px; background:red; padding:1px 6px; border-radius:50%; font-size:10px; display:none;">0</span>
    </div>
    <i class="fas fa-user-shield" onclick="irPerfil()"></i>
</div>

<div id="p-admin" class="panel">
    <button class="btn-back" onclick="cerrarPaneles()" style="background:none; color:white; border:1px solid #444; padding:8px 12px; border-radius:6px; cursor:pointer; margin-bottom:15px;"><i class="fas fa-times"></i> Salir</button>
    <div id="admin-summary" class="card-ui" style="text-align:center; font-weight:bold; background:var(--gold); color:black;">PANEL CONTROL</div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:15px; max-width:450px; margin-inline:auto;">
        <button class="btn-gold" onclick="verAdmin('inv')">STOCK</button>
        <button class="btn-gold" onclick="verAdmin('ventas')">VENTAS</button>
    </div>
    <div id="cont-admin-tools" style="display:none; text-align:center;">
        <button class="btn-gold" style="background:white; color:black; margin-bottom:10px; max-width:450px;" onclick="abrirForm()">+ A칌ADIR PRODUCTO</button>
        <input type="text" id="busq-admin" placeholder="游댌 Buscar en inventario..." onkeyup="filtrar('admin')" style="max-width:450px;">
    </div>
    <div id="admin-content"></div>
    <div style="text-align:center;"><button class="btn-gold" onclick="logout()" style="background:#444; color:white; margin-top:20px; max-width:450px;">CERRAR SESI칍N</button></div>
</div>

<div id="p-cart" class="panel">
    <button class="btn-back" onclick="cerrarPaneles()" style="background:none; color:white; border:1px solid #444; padding:8px 12px; border-radius:6px; cursor:pointer; margin-bottom:15px;"><i class="fas fa-arrow-left"></i> Atr치s</button>
    <h2 style="text-align:center; color:var(--gold); font-family:Cinzel;">CARRITO VIP</h2>
    <div id="cart-list"></div>
    <div id="cart-footer" style="text-align:center; margin-top:20px; display:none;">
        <h2 id="total-cart" style="color:var(--gold);"></h2>
        <button class="btn-gold" onclick="finalizarCompra()">CONFIRMAR PEDIDO</button>
    </div>
</div>

<div id="p-gracias" class="panel" style="text-align:center; padding-top:80px;">
    <div class="halo-circle"><img src="https://i.ibb.co/NgksQ0Sh/photo-2025-07-20-02-21-51.jpg" class="logo-img"></div>
    <h1 style="color:var(--gold); font-family:Cinzel;">춰GRACIAS POR TU COMPRA!</h1>
    <div class="card-ui">Estamos procesando tu pedido. Redirigiendo a WhatsApp...</div>
</div>

<div id="p-form" class="panel">
    <div class="card-ui">
        <button class="btn-back" onclick="abrirPanel('p-admin')" style="background:none; color:white; border:1px solid #444; padding:8px 12px; border-radius:6px; cursor:pointer; margin-bottom:15px;"><i class="fas fa-arrow-left"></i> Volver</button>
        <h2 id="form-title" style="text-align:center; color:var(--gold);">DATOS LIBRO</h2>
        <input type="hidden" id="f-id"><input type="text" id="f-titulo" placeholder="T칤tulo"><input type="number" id="f-precio" placeholder="Precio $"><input type="number" id="f-stock" placeholder="Stock"><input type="file" id="f-file"><input type="hidden" id="f-img-url">
        <button class="btn-gold" id="btn-save-prod" onclick="guardarProducto()">GUARDAR</button>
    </div>
</div>

<div id="p-auth" class="panel">
    <button class="btn-back" onclick="cerrarPaneles()" style="background:none; color:white; border:1px solid #444; padding:8px 12px; border-radius:6px; cursor:pointer; margin-bottom:15px;"><i class="fas fa-arrow-left"></i> Atr치s</button>
    <div class="card-ui" id="v-login">
        <h2 style="text-align:center; color:var(--gold);">INICIAR SESI칍N</h2>
        <input type="email" id="l-email" placeholder="Correo"><input type="password" id="l-pass" placeholder="Contrase침a">
        <button class="btn-gold" onclick="login()">ENTRAR</button>
        <p onclick="cambiarVista('v-reg')" style="text-align:center; color:gray; cursor:pointer; margin-top:15px;">쯅o tienes cuenta? <b>Reg칤strate</b></p>
    </div>
    <div class="card-ui" id="v-reg" style="display:none;">
        <h2 style="text-align:center; color:var(--gold);">REGISTRO</h2>
        <input type="text" id="r-nom" placeholder="Nombre"><input type="email" id="r-email" placeholder="Correo"><input type="tel" id="r-tel" placeholder="WhatsApp"><input type="password" id="r-pass" placeholder="Contrase침a">
        <button class="btn-gold" id="btn-cod" onclick="solicitarCodigo()">PEDIR C칍DIGO</button>
        <div id="sec-cod" style="display:none; margin-top:10px;">
            <input type="number" id="v-cod" placeholder="C칩digo de 4 d칤gitos">
            <button class="btn-gold" onclick="validarRegistro()" style="background:#28a745; color:white;">VERIFICAR</button>
        </div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbyd-3_A5xUQfNPSSwwnLPdCGcrW6nJBFXwRbfQag1xxjkODHxTMA2kPUd6wBeD-RuOV2A/exec";
    const SOUNDS = { bubble: "https://www.myinstants.com/media/sounds/discord-notification.mp3", kaching: "https://www.myinstants.com/media/sounds/ka-ching.mp3" };
    
    let inventario = [], carrito = [], user = JSON.parse(localStorage.getItem('user_marco')) || null, codS = null;

    async function init() {
        const res = await fetch(`${API}?action=obtenerInventario`);
        inventario = await res.json();
        renderTienda(inventario);
    }

    function play(s) { 
        const audio = new Audio(SOUNDS[s]);
        audio.currentTime = 0;
        audio.play().catch(e => console.log("Audio en espera")); 
    }

    function renderTienda(data) {
        document.getElementById('box-libros').innerHTML = data.map(l => {
            const agotado = l.stock <= 0;
            return `
            <div class="libro-card">
                <div class="card-body">
                    <div class="img-box"><img src="${l.imagen}"></div>
                    <div class="info-box">
                        <span class="status ${agotado ? 'status-no' : 'status-ok'}">${agotado ? 'AGOTADO' : 'DISPONIBLE'}</span>
                        <b style="font-size:14px; display:block; margin-bottom:5px; height:36px; overflow:hidden;">${l.titulo}</b>
                        <span style="color:var(--gold); font-weight:bold; font-size:18px;">$${l.precio.toFixed(2)}</span><br>
                        <button class="btn-gold" onclick="add(${l.id})" 
                            style="padding:8px 15px; font-size:11px; margin-top:8px; width:auto;" 
                            ${agotado ? 'disabled style="opacity:0.4;"' : ''}>
                            ${agotado ? 'SIN STOCK' : 'A칌ADIR'}
                        </button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function notify(m, t='success') {
        const el = document.getElementById('toast');
        el.innerHTML = `<div class="msg-card msg-${t}">${m}</div>`;
        el.style.display = 'block';
        if(t === 'success') play('bubble');
        setTimeout(() => el.style.display = 'none', 2500);
    }

    function add(id) {
        if(!user) return abrirPanel('p-auth');
        const l = inventario.find(x => x.id === id);
        const ex = carrito.find(x => x.id === id);
        if(ex) ex.cant++; else carrito.push({...l, cant: 1});
        updateCart(); notify("A침adido al carrito");
    }

    function updateCart() {
        const can = carrito.reduce((a,b)=> a+b.cant, 0);
        document.getElementById('badge').innerText = can;
        document.getElementById('badge').style.display = can > 0 ? 'block' : 'none';
        let total = 0;
        document.getElementById('cart-list').innerHTML = carrito.map((it, i) => {
            total += it.precio * it.cant;
            return `<div class="card-ui" style="display:flex; align-items:center; gap:10px;">
                <img src="${it.imagen}" width="40" height="50" style="object-fit:cover;">
                <div style="flex:1;"><b>${it.titulo}</b><br>$${it.precio}</div>
                <div style="display:flex; align-items:center; gap:5px;">
                    <button style="background:none; border:1px solid #444; color:white; width:25px;" onclick="mod(${i},-1)">-</button>
                    <b>${it.cant}</b>
                    <button style="background:none; border:1px solid #444; color:white; width:25px;" onclick="mod(${i},1)">+</button>
                </div>
            </div>`;
        }).join('');
        document.getElementById('total-cart').innerText = `TOTAL: $${total.toFixed(2)}`;
        document.getElementById('cart-footer').style.display = can > 0 ? 'block' : 'none';
    }

    function mod(i, v) { carrito[i].cant += v; if(carrito[i].cant <= 0) carrito.splice(i,1); updateCart(); }

    async function finalizarCompra() {
        play('kaching');
        const tot = document.getElementById('total-cart').innerText;
        let detT = `游댒 <b>PEDIDO VIP</b>\n游녻 <b>Cliente:</b> ${user.nombre}\n游 <b>Detalle:</b>\n`;
        carrito.forEach(x => detT += `游닀 ${x.titulo} (x${x.cant})\n`);
        detT += `游눯 <b>${tot}</b>`;
        abrirPanel('p-gracias');
        await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'finalizarVenta', cliente: user.nombre, telefono: user.telefono, detalleExcel: carrito.map(x=> `${x.titulo} (x${x.cant})`).join(' | '), total: tot.replace('TOTAL: $',''), resumenTelegram: detT, items: carrito })});
        setTimeout(() => window.location.href = `https://wa.me/584127145675?text=${encodeURIComponent(detT.replace(/<[^>]*>/g, ''))}`, 2000);
    }

    async function verAdmin(tipo) {
        const cont = document.getElementById('admin-content');
        cont.innerHTML = "Cargando...";
        document.getElementById('cont-admin-tools').style.display = tipo === 'inv' ? 'block' : 'none';
        if(tipo === 'inv') {
            document.getElementById('admin-summary').innerText = "INVENTARIO STOCK";
            renderAdminList(inventario);
        } else {
            const res = await fetch(`${API}?action=obtenerVentas`);
            const v = await res.json();
            document.getElementById('admin-summary').innerText = "HISTORIAL VENTAS";
            cont.innerHTML = `<button class="btn-gold" style="background:red; color:white; margin-bottom:15px;" onclick="eliminar('Ventas', 0, true)">BORRAR HISTORIAL</button>` +
                v.map(v => `<div class="card-ui" style="font-size:11px;"><span style="color:var(--gold);">${new Date(v[0]).toLocaleString()}</span><br><b>${v[1]}</b>: $${v[3]}<br>${v[2]}</div>`).reverse().join('');
        }
    }

    function renderAdminList(data) {
        document.getElementById('admin-content').innerHTML = data.map(l => `
            <div class="admin-card">
                <div class="img-box" style="width:60px; height:80px; padding:4px;"><img src="${l.imagen}"></div>
                <div style="flex:1;">
                    <b style="font-size:16px;">${l.titulo}</b><br>
                    <span style="color:var(--gold);">Precio: $${l.precio}</span><br>
                    <span style="color:${l.stock > 0 ? '#00ff64':'#ff3333'};">Stock: ${l.stock}</span>
                </div>
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <i class="fas fa-edit" style="color:var(--gold); font-size:20px; cursor:pointer;" onclick='abrirForm(${JSON.stringify(l)})'></i>
                    <i class="fas fa-trash" style="color:red; font-size:20px; cursor:pointer;" onclick="eliminar('Inventario', ${l.id})"></i>
                </div>
            </div>`).join('');
    }

    function abrirForm(l = null) {
        abrirPanel('p-form');
        document.getElementById('f-id').value = l ? l.id : "";
        document.getElementById('f-titulo').value = l ? l.titulo : "";
        document.getElementById('f-precio').value = l ? l.precio : "";
        document.getElementById('f-stock').value = l ? l.stock : "";
        document.getElementById('f-img-url').value = l ? l.imagen : "";
        document.getElementById('form-title').innerText = l ? "EDITAR LIBRO" : "NUEVO LIBRO";
    }

    async function guardarProducto() {
        const btn = document.getElementById('btn-save-prod'); btn.disabled = true; btn.innerText = "PROCESANDO...";
        const file = document.getElementById('f-file').files[0];
        let p = { action: 'gestionarLibro', id: document.getElementById('f-id').value, titulo: document.getElementById('f-titulo').value, precio: document.getElementById('f-precio').value, stock: document.getElementById('f-stock').value, imagen: document.getElementById('f-img-url').value };
        const enviar = async (payload) => {
            await fetch(API, { method: 'POST', body: JSON.stringify(payload) });
            const r = await fetch(`${API}?action=obtenerInventario`);
            inventario = await r.json(); verAdmin('inv'); abrirPanel('p-admin'); notify("춰Inventario actualizado!");
            btn.disabled = false; btn.innerText = "GUARDAR";
        };
        if(file) {
            const r = new FileReader(); r.readAsDataURL(file);
            r.onload = () => { p.archivoBase64 = r.result; enviar(p); };
        } else enviar(p);
    }

    async function eliminar(tabla, id, todo = false) {
        if(!confirm("쮼st치s seguro de esta acci칩n?")) return;
        await fetch(API, { method: 'POST', body: JSON.stringify({ action: todo?'vaciarVentas':'eliminarFila', tabla: tabla, id: id })});
        if(todo) location.reload(); else { const r = await fetch(`${API}?action=obtenerInventario`); inventario = await r.json(); verAdmin('inv'); }
    }

    function filtrar(modo) {
        const t = document.getElementById(modo === 'tienda' ? 'busq-tienda' : 'busq-admin').value.toLowerCase();
        const filt = inventario.filter(x => x.titulo.toLowerCase().includes(t));
        if(modo === 'tienda') renderTienda(filt); else renderAdminList(filt);
    }

    function abrirPanel(id) { cerrarPaneles(); document.getElementById(id).classList.add('active'); }
    function cerrarPaneles() { document.querySelectorAll('.panel').forEach(p => p.classList.remove('active')); }
    function cambiarVista(v) { document.getElementById('v-login').style.display = v==='v-reg'?'none':'block'; document.getElementById('v-reg').style.display = v==='v-reg'?'block':'none'; }
    function irPerfil() { if(!user) abrirPanel('p-auth'); else if(user.rol === 'ADMIN') { abrirPanel('p-admin'); verAdmin('inv'); } else notify("Hola, " + user.nombre); }
    async function login() {
        const res = await fetch(`${API}?action=login&correo=${document.getElementById('l-email').value}&pass=${document.getElementById('l-pass').value}`);
        const data = await res.json();
        if(data.success) { localStorage.setItem('user_marco', JSON.stringify(data)); location.reload(); } else notify("Credenciales incorrectas", "error");
    }
    function logout() { localStorage.removeItem('user_marco'); location.reload(); }
    async function solicitarCodigo() {
        notify("Enviando c칩digo...");
        const res = await fetch(`${API}?action=enviarCodigo&correo=${document.getElementById('r-email').value}`);
        const data = await res.json(); codS = data.codigo;
        document.getElementById('sec-cod').style.display = 'block'; notify("C칩digo enviado");
    }
    async function validarRegistro() {
        if(document.getElementById('v-cod').value != codS) return notify("C칩digo incorrecto", "error");
        await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'registrarUsuario', nombre: document.getElementById('r-nom').value, correo: document.getElementById('r-email').value, telefono: document.getElementById('r-tel').value, pass: document.getElementById('r-pass').value })});
        notify("Registro exitoso"); cambiarVista('v-login');
    }

    init();
</script>
</body>
</html>